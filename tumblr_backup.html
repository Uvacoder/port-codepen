<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>{Title}{block:PermalinkPage}{block:PostSummary} â€” {PostSummary}{/block:PostSummary}{/block:PermalinkPage}</title>
        {block:Description}
        <meta name="description" content="{MetaDescription}">
        {/block:Description}

        <meta name='text:Disqus Shortname' content='' />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="{Favicon}">
        <link rel="apple-touch-icon-precomposed" href="{PortraitURL-128}">
        <link rel="alternate" type="application/rss+xml" href="{RSS}">

        <style>
            {CustomCSS}
        </style>
    </head>
    <body>

        <div class="container">

            <header class="main-header">
                <iframe class="btn social-badge"
                        frameborder="0"
                        border="0"
                        scrolling="no"
                        allowtransparency="true"
                        width="45"
                        height="20"
                        src="https://platform.tumblr.com/v2/follow_button.html?type=follow-blog&amp;tumblelog=x0r&amp;color=white">
                </iframe>
                <iframe class="btn social-badge"
                        frameborder="0"
                        border="0"
                        scrolling="no"
                        allowtransparency="true"
                        width="123px"
                        height="20px"
                        src="https://ghbtns.com/github-btn.html?user=scriptype&amp;type=follow">
                </iframe>

                <h1 class="main-title"><a href="/">Enes</a></h1>
                <nav class="main-navigation">
                    <a class="navigation-item" href="/about-me">About</a>
                    <a class="navigation-item" href="/tagged/code">Code</a>
                    <a class="navigation-item" href="/tagged/photography">Photo</a>
                    <a class="navigation-item" href="/tagged/videography">Video</a>
                    <a class="navigation-item" href="/ask">AMA</a>
                </nav>

                <form class="search" id="search" action="/search" method="get">
                    <label for="q">
                        Search:
                        <input
                            name="q"
                            value=""
                            id="q"
                            class="search-input"
                            type="text" />
                    </label>
                </form>
            </header>

            <section class="main-pagination main-pagination--top">
                {block:IndexPage}
                    {block:Pagination}
                        {block:PreviousPage}
                            <a class="pagination-item pagination-item--real"
                               href="{PreviousPage}">&laquo; Newer</a>
                        {/block:PreviousPage}
                    {/block:Pagination}
                    <span class="pagination-item pagination-item--placeholder dimmed">
                        &laquo; Newer
                    </span>
                    {block:Pagination}
                        {block:NextPage}
                            <a class="pagination-item pagination-item--real"
                               href="{NextPage}">Older &raquo;</a>
                        {/block:NextPage}
                    {/block:Pagination}
                    <span class="pagination-item pagination-item--placeholder dimmed">
                        Older &raquo;
                    </span>
                {/block:IndexPage}
            </section>

            <main class="main-contents
                         main-contents--{block:Permalink}permalink{/block:Permalink}{block:IndexPage}index{block:IndexPage}">
            {block:Posts inlineMediaWidth="500" inlineNestedMediaWidth="250"}
                <article class="main-article
                                main-article--{PostType}
                                {block:PermalinkPage}
                                main-article--permalink
                                {/block:PermalinkPage}
                                {block:IndexPage}
                                main-article--index
                                {/block:IndexPage}
                                {block:RebloggedFrom}
                                main-article--reblog
                                {/block:RebloggedFrom}">
                    {block:Text}
                        <header>
                            {block:Title}
                                <h2>
                                {block:IndexPage}
                                    <a href="{Permalink}" class="permalink">{Title}</a>
                                {/block:IndexPage}
                                {block:PermalinkPage}
                                    {Title}
                                {/block:PermalinkPage}
                                </h2>
                            {/block:Title}

                            {block:RebloggedFrom}
                                <a href="{ReblogParentURL}">
                                    {ReblogParentName}
                                </a>
                            {/block:RebloggedFrom}
                        </header>
                        {block:Body}
                            {Body}
                        {/block:Body}
                    {/block:Text}
                    {block:Photo}
                        <figure>
                            {block:Caption}
                                <figcaption>
                                    <a href="{Permalink}" class="permalink">
                                        {Caption}
                                    </a>
                                </figcaption>
                            {/block:Caption}

                            {LinkOpenTag}
                                {block:PermalinkPage}
                                <img src="{PhotoURL-HighRes}"
                                     alt="{PhotoAlt}"
                                     width="{PhotoWidth-HighRes}"
                                     height="{PhotoHeight-HighRes}" />
                                {/block:PermalinkPage}
                                {block:IndexPage}
                                <img src="{PhotoURL-250}"
                                     alt="{PhotoAlt}"
                                     width="{PhotoWidth-HighRes}"
                                     height="{PhotoHeight-HighRes}" />
                                {/block:IndexPage}
                            {LinkCloseTag}
                        </figure>
                    {/block:Photo}
                    {block:Photoset}
                        <figure>
                            {block:Caption}
                                <figcaption>
                                    <a href="{Permalink}" class="permalink">
                                        {Caption}
                                    </a>
                                </figcaption>
                            {/block:Caption}

                            {block:RebloggedFrom}
                                <a href="{ReblogParentURL}">
                                    {ReblogParentName}
                                </a>
                            {/block:RebloggedFrom}

                            {Photoset}
                        </figure>
                    {/block:Photoset}
                    {block:Quote}
                        <blockquote>
                            {Quote}
                        </blockquote>
                        {block:Source}
                            {Source}
                        {/block:Source}
                    {/block:Quote}
                    {block:Link}
                        <a target"_blank" href="{URL}">
                            <h2>
                                {Name}
                            </h2>
                            {block:Thumbnail}
                                <img src="{Thumbnail-HighRes}" />
                            {/block:Thumbnail}
                            {block:Host}
                            <p>
                                {Host}
                            </p>
                            {/block:Host}
                        </a>
                        {block:Excerpt}
                        <p>
                            {Excerpt}
                        </p>
                        {/block:Excerpt}
                        {block:Description}
                        <p>
                            {Description}
                        </p>
                        {/block:Description}
                        {block:Author}{Author}{/block:Author}
                    {/block:Link}
                    {block:Chat}
                        <ul>
                            {block:Lines}
                                <li>
                                    {block:Label}
                                        {Label}
                                    {/block:Label}&nbsp;
                                    {Line}
                                </li>
                            {/block:Lines}
                        </ul>
                    {/block:Chat}
                    {block:Audio}
                        {block:Caption}
                            {Caption}
                        {/block:Caption}
                        {block:AudioEmbed}
                            {AudioEmbed color="white"}
                        {/block:AudioEmbed}
                    {/block:Audio}
                    {block:Video}
                    <figure>
                        {block:Caption}
                            <figcaption>
                                <a href="{Permalink}" class="permalink">
                                    {Caption}
                                </a>
                            </figcaption>
                        {/block:Caption}
                        {block:IndexPage}
                            {Video-250}
                        {/block:IndexPage}
                        {block:PermalinkPage}
                            {Video-700}
                        {/block:PermalinkPage}
                    </figure>
                    {/block:Video}
                    {block:Answer}
                        <p>{Asker} asked:</p>
                        <p>{Question}</p>
                        <img src="{AskerPortraitURL-96}" />
                        {block:Answerer}
                            <p>{Answerer} answered:</p>
                            <p>{Answer}</p>
                            <img src="{AnswererPortraitURL-96}" />
                        {/block:Answerer}
                        <div>{Replies}</div>
                    {/block:Answer}
                    <footer>
                        {block:IndexPage}
                            {block:Date}
                            <a href="{Permalink}" class="permalink date">{ShortMonth} {DayOfMonthWithZero} {Year}</a>
                            {/block:Date}
                            {block:NoteCount}
                            <a href="{Permalink}" class="permalink note-count">{NoteCountWithLabel}</a>
                            {/block:NoteCount}
                        {/block:IndexPage}
                        {block:PermalinkPage}
                            {block:RebloggedFrom}
                                <a href="{ReblogParentURL}">
                                    {ReblogParentName}
                                </a>
                            {/block:RebloggedFrom}
                            {block:ContentSource}
                                <a href="{SourceURL}">
                                    {lang:Source}: {SourceTitle}
                                </a>
                            {/block:ContentSource}
                            {block:HasTags}
                                {block:Tags}
                                     <a href="{TagURL}" class="tag">{Tag}</a>
                                {/block:Tags}
                            {/block:HasTags}
                            {block:Date}
                            <a href="{Permalink}" class="permalink date">{ShortMonth} {DayOfMonthWithZero} {Year}</a>
                            {/block:Date}
                        {/block:PermalinkPage}
                    </footer>
                    {block:PermalinkPage}
                        <section>
                            {block:NoteCount}
                                {block:PostNotes}
                                    {NoteCountWithLabel}
                                    {PostNotes-16}
                                {/block:PostNotes}
                            {/block:NoteCount}
                        </section>
                        <input type="hidden" id="post-id" value="{PostID}" />
                    {/block:PermalinkPage}
                </article>
            {/block:Posts}

            {block:PermalinkPage}
                <div id="disqus_thread" class="main-comments"></div>
            {block:PermalinkPage}
            </main>

            <section class="main-pagination main-pagination--bottom {block:NoSearchResults}hidden{/block:NoSearchResults}">
                {block:IndexPage}
                    {block:Pagination}
                        {block:PreviousPage}
                            <a class="pagination-item pagination-item--real"
                               href="{PreviousPage}">&laquo; Newer</a>
                        {/block:PreviousPage}
                    {/block:Pagination}
                    <span class="pagination-item pagination-item--placeholder dimmed">
                        &laquo; Newer
                    </span>
                    {block:Pagination}
                        {block:NextPage}
                            <a class="pagination-item pagination-item--real"
                               href="{NextPage}">Older &raquo;</a>
                        {/block:NextPage}
                    {/block:Pagination}
                    <span class="pagination-item pagination-item--placeholder dimmed">
                        Older &raquo;
                    </span>
                {/block:IndexPage}
            </section>


            <footer class="main-footer">
                <p><em>v.2 - Mon, Aug 22, 2016</em></p>
                <p>
                    This blog is an
                    <a href="https://github.com/scriptype/non-fancy-homepage">open source project</a>.
                    Feel free to report bugs and do whatever contribution you feel relevant.
                </p>

            </footer>

        </div>

        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone-min.js"></script>

        <script type="text/javascript">

            function safeTitle(fn) {
              return fn.toString()
                .replace(/\n/g, '')
                .replace('function', '')
                .replace('()', '')
                .replace(/{\/\*/, '')
                .replace(/\*\/\}$/, '')
                .trim()
            }

            function FollowingBlogsDataModule() {
              // {block:Following}
              return [
                // {block:Followed}
                {
                  avatar: '{FollowedPortraitURL-16}',
                  title: safeTitle(function(){/*{FollowedTitle}*/}),
                  name: '{FollowedName}',
                  url: '{FollowedURL}'
                },
                // {block:Followed}
              ]
              // {/block:Following}
              return []
            }

            function FollowingBlogsModule() {
              var followingData = FollowingBlogsDataModule()
              var sortedFollowingData = followingData.sort(function(p, n) {
                var a = (p.title[0] || '').toUpperCase()
                var b = (n.title[0] || '').toUpperCase()
                return a > b ? 1 : (b > a ? -1 : 0)
              })
              return ''                                               +
                '<h3>Blogs I follow:</h3>'                            +
                '<ol class="following">'                              +
                  sortedFollowingData.map(function(fw) {
                    return ''                                         +
                      '<li>'                                          +
                        '<a href="' + fw.url  + '" target="_blank">'  +
                          '<img src="' + fw.avatar + '" '             +
                               'alt="' + fw.name + '" />'             +
                        '</a> '                                       +
                        '<a href="' + fw.url  + '" target="_blank">'  +
                          fw.title                                    +
                        '</a>'                                        +
                      '</li>'
                  }).join('')                                         +
                '</ol>'
            }

            function RouterModule() {
              return Backbone.Router.extend({
                initialize: function (options) {
                  this.renderRule = options.renderRule
                  this.onRoute = options.onRoute
                },

                routes: {
                  '': 'home',
                  'about-me': 'aboutMe',
                  'tagged/*path': 'tagged',
                  'search/*path': 'search',
                  'post/*path': 'post',
                  'page/:number': 'page',
                  'ask': 'ask',
                  '*notfound': 'notFound'
                },

                _onRoute: function(route) {
                  if (this.renderRule(route)) {
                    fetch(route)
                      .then(function(result) { return result.text() })
                      .then(function(text) {
                        if (typeof this.onRoute === 'function') {
                          this.onRoute(text, route)
                        }
                      }.bind(this))
                  }
                },

                notFound: function(route) {
                  this._onRoute(route)
                },

                home: function() {
                  this._onRoute('/')
                },

                aboutMe: function() {
                  this._onRoute('/about-me')
                },

                tagged: function(path) {
                  this._onRoute('/tagged/' + path)
                },

                search: function(path) {
                  this._onRoute('/search/' + (path || ''))
                },

                post: function(path) {
                  this._onRoute('/post/' + path)
                },

                page: function(pageNumber) {
                  this._onRoute('/page/' + pageNumber)
                },

                ask: function() {
                  this._onRoute('/ask')
                }
              })
            }

            var Utils = {
              DOMFragmentFromText: function(text) {
                var fragment = document.createDocumentFragment()
                var container = document.createElement('div')
                container.insertAdjacentHTML('beforeend', text)
                fragment.appendChild(container)
                return fragment.children[0]
              },

              hide: function(element) {
                element.style.cssText = 'transition: none; opacity: 0;'
              },

              fadeIn: function(element) {
                element.classList.add('fade-in')
                setTimeout(function() {
                  element.classList.remove('fade-in')
                }, 300)
              },

              getTumblrIframe() {
                return (
                  document.getElementsByName('desktop-logged-in-controls')[0] ||
                  document.getElementsByClassName('tmblr-iframe')[0] ||
                  document.querySelector('iframe[src*="dashboard/iframe"]')
                )
              },

              getPostID() {
                return document.getElementById('post-id').value
              }
            }

            var App = {
              CONTENT: '.main-contents',
              ABOUT_ME_CONTENT: '.main-contents .main-article',
              TOP_PAGINATION: '.main-pagination--top',
              BOTTOM_PAGINATION: '.main-pagination--bottom',
              PAGINATION_LINKS: '.main-pagination a',
              BOTTOM_PAGINATION_LINKS: '.main-pagination--bottom a',
              NAVIGATION_LINKS: '.main-navigation a',
              TITLE: '.main-title a',
              POST_TITLE: '.main-article:not(.main-article--permalink) .permalink, .read_more',
              DISCUSS_SCRIPT_ID: 'disqus_embed',

              skippedFirstRender: false,

              bindLinksToRouter: function(nodes) {
                ;[].slice.call(nodes).forEach(function(node) {
                  node.addEventListener('click', function(event) {
                    if (!event.metaKey && !event.altKey && !event.ctrlKey && !event.shiftKey && event.which !== 2) {
                      event.preventDefault()
                      var origin = document.location.origin
                      var route = node.href.replace(origin + '/', '')
                      this.router.navigate(route, { trigger: true })
                    }
                  }.bind(this))
                }.bind(this))
              },

              onSearch: function(event) {
                var value = event.which || event.keyCode
                var notChanged = (
                    value === 36 || value === 37 || value === 38 || value === 39 ||
                    value === 16 || value === 27 || value === 20 ||
                    event.ctrlKey || event.shiftKey || event.metaKey
                )
                if (!notChanged) {
                  this.router.navigate('search/' + event.target.value, { trigger: true })
                }
              },

              onRoute: function(result, route) {
                var fragment = Utils.DOMFragmentFromText(result)

                // Get content section
                var contents = document.querySelector(this.CONTENT)
                // Refresh content section
                Utils.hide(contents)
                contents.outerHTML = fragment.querySelector(this.CONTENT).outerHTML
                Utils.fadeIn(document.querySelector(this.CONTENT))
                this.bindLinksToRouter(document.querySelectorAll(this.POST_TITLE))

                // Get pagination sections
                var topPagination = document.querySelector(this.TOP_PAGINATION)
                var bottomPagination = document.querySelector(this.BOTTOM_PAGINATION)
                // Refresh pagination sections
                topPagination.outerHTML = fragment.querySelector(this.TOP_PAGINATION).outerHTML
                bottomPagination.outerHTML = fragment.querySelector(this.BOTTOM_PAGINATION).outerHTML
                this.bindLinksToRouter(document.querySelectorAll(this.PAGINATION_LINKS))
                this.bindBottomPaginationLinksClickHandlers()

                // Reset search input's value if it's not search route any more
                if (!/^\/search/.test(route)) {
                  document.getElementById('q').value = ''
                }

                // Perform some dynamic rendering if it's /about-me
                if (/^\/about-me$/.test(route)) {
                  this.renderAboutMePage()
                }

                // Update page title
                document.title = fragment.querySelector('title').innerText

                // Disqus
                if (/^\/post\//.test(route)) {
                  this.renderDisqus(route)
                }

                // Handle tumblr iframe
                var tumblrIframe = Utils.getTumblrIframe()
                if (!tumblrIframe) {
                  console.info('no iframe')
                  return
                }
                var iframeSrc = decodeURIComponent(tumblrIframe.src)
                var iframeSrcRoot = iframeSrc.split('?')[0]
                var iframeSrcQuery = iframeSrc.split('?')[1]
                var iframeQueryParts = iframeSrcQuery.split('&')
                var newSrc = [iframeSrcRoot, iframeQueryParts.map(function(part) {
                  var pid = ''
                  if (/src=/.test(part)) {
                    if (/post/.test(route)) {
                      pid = 'pid=' + Utils.getPostID()
                    }
                    return pid + '&' + 'src=' + encodeURIComponent(document.location.origin + route)
                  }
                  if (/pid=/.test(part) && !/^\/post/.test(route)) {
                    return ''
                  }
                  return part
                }).join('&')].join('?')
                if (tumblrIframe.src !== newSrc) {
                  tumblrIframe.contentWindow.location.replace(newSrc)
                }
              },

              renderAboutMePage() {
                var aboutMeContent = document.querySelector(this.ABOUT_ME_CONTENT)
                var followingBlogs = FollowingBlogsModule()
                aboutMeContent.insertAdjacentHTML('beforeend', followingBlogs)
              },

              renderDisqus(route) {
                var previousEmbed = document.getElementById(this.DISCUSS_SCRIPT_ID)
                if (previousEmbed) {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = route.match(/\/post\/(.+)\//)[1]
                      this.page.url = document.location.href
                      this.page.title = document.title
                    }
                  })

                } else {
                  var dsq = document.createElement('script')
                  var disqus_shortname = '{text:Disqus Shortname}'
                  dsq.type = 'text/javascript'
                  dsq.async = true
                  dsq.id = this.DISCUSS_SCRIPT_ID
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'
                  var target = (
                    document.getElementsByTagName('head')[0] ||
                    document.getElementsByTagName('body')[0]
                  )
                  target.appendChild(dsq)
                }
              },

              bindBottomPaginationLinksClickHandlers() {
                ;[].slice.call(document.querySelectorAll(this.BOTTOM_PAGINATION_LINKS))
                  .forEach(function(el) {
                    el.addEventListener('click', function() {
                      document.location.hash = 'top'
                    })
                  })
              },

              init: function() {
                if (!window.history || !window.fetch) {
                  return
                }

                var Router = RouterModule()

                this.router = new Router({
                  renderRule: function (route) {
                    if (this.skippedFirstRender) {
                      return true

                    } else {
                      if (/^\/about-me$/.test(route)) {
                        this.renderAboutMePage()
                      }
                      if (/^\/post\//.test(route)) {
                        this.renderDisqus(route)
                      }
                      this.skippedFirstRender = true
                      return false
                    }
                  }.bind(this),

                  onRoute: this.onRoute.bind(this)
                })

                this.router.on('route', function(route) {
                  console.log('routing:', route)
                })

                Backbone.history.start({ pushState: true })

                this.bindLinksToRouter(document.querySelectorAll(this.TITLE))
                this.bindLinksToRouter(document.querySelectorAll(this.POST_TITLE))
                this.bindLinksToRouter(document.querySelectorAll(this.NAVIGATION_LINKS))
                this.bindLinksToRouter(document.querySelectorAll(this.PAGINATION_LINKS))
                this.bindBottomPaginationLinksClickHandlers()

                var searchForm = document.getElementById('search')
                var searchInput = document.getElementById('q')
                var debouncedSearch = _.debounce(this.onSearch.bind(this), 300)
                searchInput.addEventListener('keydown', debouncedSearch)
                searchForm.addEventListener('submit', function(event) { event.preventDefault() })
              }
            }

            window.addEventListener('DOMContentLoaded', App.init.bind(App))

        </script>

    </body>
</html>
