<!DOCTYPE html>
<html>
    <head>
        {MobileAppHeaders}
        <meta charset="utf-8">
        <title>{Title}{block:PermalinkPage}{block:PostSummary} — {PostSummary}{/block:PostSummary}{/block:PermalinkPage}</title>
        {block:Description}
        <meta name="description" content="{MetaDescription}">
        {/block:Description}

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="{Favicon}">
        <link rel="apple-touch-icon-precomposed" href="{PortraitURL-128}">
        <link rel="alternate" type="application/rss+xml" href="{RSS}">

        <style>
            {CustomCSS}
        </style>
    </head>
    <body>

        <div class="container">

            <header class="main-header">
                <iframe class="btn x0r-btn"
                        frameborder="0"
                        border="0"
                        scrolling="no"
                        allowtransparency="true"
                        height="20"
                        width="45"
                        src="https://platform.tumblr.com/v2/follow_button.html?type=follow-blog&amp;tumblelog=x0r&amp;color=white">
                </iframe>

                <h1 class="main-title"><a href="/">Enes</a></h1>
                <nav class="main-navigation">
                    <a href="/about-me">About me</a>
                    <a href="/tagged/photography">Photo</a>
                    <a href="/tagged/videography">Video</a>
                    <a href="/tagged/turkce">Türkçe</a>
                </nav>
                <form class="search" id="search" action="/search" method="get">
                    <label for="q">
                        Search:
                        <input name="q" value="" id="q" type="text" />
                    </label>
                </form>
            </header>

            <section class="main-pagination">
                {block:IndexPage}
                    {block:Pagination}
                        {block:PreviousPage}
                            <a class="pagination-item pagination-item--real"
                               href="{PreviousPage}">&laquo; Newer</a>
                        {/block:PreviousPage}
                    {/block:Pagination}
                    <span class="pagination-item pagination-item--placeholder dimmed">
                        &laquo; Newer
                    </span>
                    {block:Pagination}
                        {block:NextPage}
                            <a class="pagination-item pagination-item--real"
                               href="{NextPage}">Older &raquo;</a>
                        {/block:NextPage}
                    {/block:Pagination}
                    <span class="pagination-item pagination-item--placeholder dimmed">
                        Older &raquo;
                    </span>
                {/block:IndexPage}
            </section>

            <main class="main-contents
                         main-contents--{block:Permalink}permalink{/block:Permalink}{block:IndexPage}index{block:IndexPage}">
            {block:Posts inlineMediaWidth="500" inlineNestedMediaWidth="250"}
                <article class="main-article
                                main-article--{PostType}
                                {block:PermalinkPage}
                                main-article--permalink
                                {/block:PermalinkPage}
                                {block:IndexPage}
                                main-article--index
                                {/block:IndexPage}">
                    {block:Text}
                        <header>
                            {block:Title}
                                <h2>
                                {block:IndexPage}
                                    <a href="{Permalink}" class="permalink">{Title}</a>
                                {/block:IndexPage}
                                {block:PermalinkPage}
                                    {Title}
                                {/block:PermalinkPage}
                                </h2>
                            {/block:Title}

                            {block:RebloggedFrom}
                                <a href="{ReblogParentURL}">
                                    {ReblogParentName}
                                </a>
                            {/block:RebloggedFrom}
                        </header>
                        {block:Body}
                            {Body}
                        {/block:Body}
                    {/block:Text}
                    {block:Photo}
                        <figure>
                            {block:Caption}
                                <figcaption>
                                    <a href="{Permalink}" class="permalink">
                                        {Caption}
                                    </a>
                                </figcaption>
                            {/block:Caption}

                            {block:RebloggedFrom}
                                <a href="{ReblogParentURL}">
                                    {ReblogParentName}
                                </a>
                            {/block:RebloggedFrom}

                            {LinkOpenTag}
                                {block:PermalinkPage}
                                <img src="{PhotoURL-HighRes}"
                                     alt="{PhotoAlt}"
                                     width="{PhotoWidth-HighRes}"
                                     height="{PhotoHeight-HighRes}" />
                                {/block:PermalinkPage}
                                {block:IndexPage}
                                <img src="{PhotoURL-250}"
                                     alt="{PhotoAlt}"
                                     width="{PhotoWidth-HighRes}"
                                     height="{PhotoHeight-HighRes}" />
                                {/block:IndexPage}
                            {LinkCloseTag}
                        </figure>
                    {/block:Photo}
                    {block:Photoset}
                        <figure>
                            {block:Caption}
                                <figcaption>
                                    <a href="{Permalink}" class="permalink">
                                        {Caption}
                                    </a>
                                </figcaption>
                            {/block:Caption}

                            {block:RebloggedFrom}
                                <a href="{ReblogParentURL}">
                                    {ReblogParentName}
                                </a>
                            {/block:RebloggedFrom}

                            {Photoset}

                            {block:Caption}
                                <figcaption>
                                    {Caption}
                                </figcaption>
                            {/block:Caption}
                        </figure>
                    {/block:Photoset}
                    {block:Quote}
                        <blockquote>
                            {Quote}
                        </blockquote>
                        {block:Source}
                            {Source}
                        {/block:Source}
                    {/block:Quote}
                    {block:Link}
                        <a {Target} href="{URL}">
                            {block:Thumbnail}
                                <img src="{Thumbnail-HighRes}" />
                            {/block:Thumbnail}
                            {block:Host}{Host}{/block:Host}
                            {Name}
                            {block:Excerpt}{Excerpt}{/block:Excerpt}
                            {block:Author}{Author}{/block:Author}
                            {block:Description}
                                {Description}
                            {/block:Description}
                        </a>
                    {/block:Link}
                    {block:Chat}
                        <ul>
                            {block:Lines}
                                <li>
                                    {block:Label}
                                        {Label}
                                    {/block:Label}&nbsp;
                                    {Line}
                                </li>
                            {/block:Lines}
                        </ul>
                    {/block:Chat}
                    {block:Audio}
                        {block:Caption}
                            {Caption}
                        {/block:Caption}
                        {block:AudioEmbed}
                            {AudioEmbed color="white"}
                        {/block:AudioEmbed}
                    {/block:Audio}
                    {block:Video}
                    <figure>
                        {block:Caption}
                            <figcaption>
                                <a href="{Permalink}" class="permalink">
                                    {Caption}
                                </a>
                            </figcaption>
                        {/block:Caption}
                        {block:IndexPage}
                            {Video-250}
                        {/block:IndexPage}
                        {block:PermalinkPage}
                            {Video-700}
                        {/block:PermalinkPage}
                    </figure>
                    {/block:Video}
                    {block:Answer}
                        <p>{Asker} asked:</p>
                        <p>{Question}</p>
                        <img src="{AskerPortraitURL-96}" />
                        {block:Answerer}
                            <p>{Answerer} answered:</p>
                            <p>{Answer}</p>
                            <img src="{AnswererPortraitURL-96}" />
                        {/block:Answerer}
                        <div>{Replies}</div>
                    {/block:Answer}
                    <footer>
                        {block:IndexPage}
                            {block:Date}
                            <a href="{Permalink}" class="permalink date">{ShortMonth} {DayOfMonthWithZero} {Year}</a>
                            {/block:Date}
                            {block:NoteCount}
                            <a href="{Permalink}" class="permalink note-count">{NoteCountWithLabel}</a>
                            {/block:NoteCount}
                        {/block:IndexPage}
                        {block:PermalinkPage}
                            {block:RebloggedFrom}
                                <a href="{ReblogParentURL}">
                                    {ReblogParentName}
                                </a>
                            {/block:RebloggedFrom}
                            {block:ContentSource}
                                <a href="{SourceURL}">
                                    {lang:Source}: {SourceTitle}
                                </a>
                            {/block:ContentSource}
                            {block:HasTags}
                                {block:Tags}
                                     <a href="{TagURL}" class="tag">{Tag}</a>
                                {/block:Tags}
                            {/block:HasTags}
                            {block:Date}
                            <a href="{Permalink}" class="permalink date">{ShortMonth} {DayOfMonthWithZero} {Year}</a>
                            {/block:Date}
                        {/block:PermalinkPage}
                    </footer>
                    {block:PermalinkPage}
                        <section>
                            {block:NoteCount}
                                {block:PostNotes}
                                    {NoteCountWithLabel}
                                    {PostNotes-16}
                                {/block:PostNotes}
                            {/block:NoteCount}
                        </section>
                        <input type="hidden" id="post-id" value="{PostID}" />
                    {/block:PermalinkPage}
                </article>
            {/block:Posts}
            </main>

            <footer class="main-footer">
                <p><em>v.2-beta - Sat, Jul 9, 2016 ~</em></p>
            </footer>

        </div>

        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone-min.js"></script>

        <script type="text/javascript">

            function RouterModule() {
              return Backbone.Router.extend({
                initialize: function (options) {
                  this.renderRule = options.renderRule
                  this.onRoute = options.onRoute
                },

                routes: {
                  '': 'home',
                  'about-me': 'aboutMe',
                  'tagged/:path': 'tagged',
                  'search/(:q)': 'search',
                  'post/*path': 'post',
                  'page/:number': 'page'
                },

                _onRoute: function(route) {
                  if (this.renderRule()) {
                    fetch(route)
                      .then(function(result) { return result.text() })
                      .then(function(text) {
                        if (typeof this.onRoute === 'function') {
                          this.onRoute(text, route)
                        }
                      }.bind(this))
                  }
                },

                home: function() {
                  this._onRoute('/')
                },

                aboutMe: function() {
                  this._onRoute('/about-me')
                },

                tagged: function(path) {
                  this._onRoute('/tagged/' + path)
                },

                search: function(q) {
                  this._onRoute('/search/' + (q || ''))
                },

                post: function(path) {
                  this._onRoute('/post/' + path)
                },

                page: function(pageNumber) {
                  this._onRoute('/page/' + pageNumber)
                }
              })
            }

            var Utils = {
              DOMFragmentFromText: function(text) {
                var fragment = document.createDocumentFragment()
                var container = document.createElement('div')
                container.insertAdjacentHTML('beforeend', text)
                fragment.appendChild(container)
                return fragment.children[0]
              },

              hide: function(element) {
                element.style.cssText = 'transition: none; opacity: 0;'
              },

              fadeIn: function(element) {
                element.classList.add('fade-in')
                setTimeout(function() {
                  element.classList.remove('fade-in')
                }, 300)
              },

              getTumblrIframe() {
                return (
                  document.getElementsByName('desktop-logged-in-controls')[0] ||
                  document.getElementsByClassName('tmblr-iframe')[0] ||
                  document.querySelector('iframe[src*="dashboard/iframe"]')
                )
              },

              getPostID() {
                return document.getElementById('post-id').value
              }
            }

            var App = {
              CONTENT: '.main-contents',
              PAGINATION: '.main-pagination',
              PAGINATION_LINKS: '.main-pagination a',
              NAVIGATION_LINKS: '.main-navigation a',
              TITLE: '.main-title a',
              POST_TITLE: '.main-article:not(.main-article--permalink) .permalink, .read_more',

              skippedFirstRender: false,

              bindLinksToRouter: function(nodes) {
                ;[].slice.call(nodes).forEach(function(node) {
                  node.addEventListener('click', function(event) {
                    event.preventDefault()
                    var origin = document.location.origin
                    var route = node.href.replace(origin + '/', '')
                    this.router.navigate(route, { trigger: true })
                  }.bind(this))
                }.bind(this))
              },

              onSearch: function(event) {
                var value = event.which || event.keyCode
                var notChanged = (
                    value === 36 || value === 37 || value === 38 || value === 39 ||
                    value === 13 || value === 16 || value === 27 || value === 20 ||
                    event.ctrlKey || event.shiftKey || event.metaKey
                )
                if (!notChanged) {
                  this.router.navigate('search/' + event.target.value, { trigger: true })
                }
              },

              onRoute: function(result, route) {
                var contents = document.querySelector(this.CONTENT)
                var pagination = document.querySelector(this.PAGINATION)
                var fragment = Utils.DOMFragmentFromText(result)

                Utils.hide(contents)
                contents.outerHTML = fragment.querySelector(this.CONTENT).outerHTML
                Utils.fadeIn(document.querySelector(this.CONTENT))
                this.bindLinksToRouter(document.querySelectorAll(this.POST_TITLE))

                pagination.outerHTML = fragment.querySelector(this.PAGINATION).outerHTML
                this.bindLinksToRouter(document.querySelectorAll(this.PAGINATION_LINKS))

                var tumblrIframe = Utils.getTumblrIframe()
                if (!tumblrIframe) {
                  console.info('no iframe')
                  return
                }
                var iframeSrc = decodeURIComponent(tumblrIframe.src)
                var iframeSrcRoot = iframeSrc.split('?')[0]
                var iframeSrcQuery = iframeSrc.split('?')[1]
                var iframeQueryParts = iframeSrcQuery.split('&')
                var newSrc = [iframeSrcRoot, iframeQueryParts.map(function(part) {
                  var pid = ''
                  if (/src=/.test(part)) {
                    if (/post/.test(route)) {
                      pid = 'pid=' + Utils.getPostID()
                    }
                    return pid + '&' + 'src=' + encodeURIComponent(document.location.origin + route)
                  }
                  if (/pid=/.test(part) && !/post/.test(route)) {
                    return ''
                  }
                  return part
                }).join('&')].join('?')
                if (tumblrIframe.src !== newSrc) {
                  tumblrIframe.src = newSrc
                }
              },

              init: function() {
                if (!window.history || !window.fetch) {
                  return
                }

                var Router = RouterModule()

                this.router = new Router({
                  renderRule: function () {
                    if (this.skippedFirstRender) {
                      return true
                    } else {
                      this.skippedFirstRender = true
                      return false
                    }
                  }.bind(this),

                  onRoute: this.onRoute.bind(this)
                })

                this.router.on('route', function(route) {
                  console.log('routing:', route)
                })

                Backbone.history.start({ pushState: true })

                this.bindLinksToRouter(document.querySelectorAll(this.TITLE))
                this.bindLinksToRouter(document.querySelectorAll(this.POST_TITLE))
                this.bindLinksToRouter(document.querySelectorAll(this.NAVIGATION_LINKS))
                this.bindLinksToRouter(document.querySelectorAll(this.PAGINATION_LINKS))

                var searchForm = document.getElementById('search')
                var searchInput = document.getElementById('q')
                var debouncedSearch = _.debounce(this.onSearch.bind(this), 300)
                searchInput.addEventListener('keydown', debouncedSearch)
                searchForm.addEventListener('submit', function(event) { event.preventDefault() })
              }
            }

            window.addEventListener('DOMContentLoaded', App.init.bind(App))

        </script>

    </body>
</html>
